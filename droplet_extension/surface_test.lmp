# LAMMPS RHEO Test Script for LAMMPS StableOct2020
dimension          2
units              lj
atom_style         rheo
boundary           s s p 
comm_modify        vel yes
newton on


##### Particle Generation     ######
####################################

## Particle Lattice/Resolution Parameters
variable           L equal 2.5
variable           sf equal .1 #scale factor for particle resolution
# n - particle number density - lattice dependent
variable           nb equal 2               #number of basis atoms depends on lattice
variable           n equal ${nb}/(${sf}^2)  #number of particles per vol
variable           del equal ${sf}*sqrt(2)/2          #distance between particles
lattice            sq2 ${n}                  # define the square lattice by its number density

#SPH Smoothing Kernel Length
variable           hd equal 3.5
variable           h3 equal ${hd}*${del}

# create simulation box
variable           dz equal 0.1*${sf}   # For 2D - make sure z-dimension only has one particle layer
region             box block -${L} ${L} -${L} ${L} -${L} ${L} units box  #create a 2d box using box units
create_box         2 box     #create a simulation box from the region box - with 2 types of atoms

# Create atoms in our whol simulation box
region             cyl cylinder z 0 0 2.5 -${dz} ${dz} units box  #create a 2d box using box units
#region             bblock block -2.5 2.5 -1.25 1.25 -${dz} ${dz} units box #rotate 0.7853981633974483 0 0 0 0 0 1 #create a 2d box using box units
#region             fullblock union 2 ablock bblock
create_atoms       1 region cyl  # creates atoms of type 1 on lattice in the region box

# Assign all particles of type 1 to a group fluid
group              fluid type 1

##### End Particle Generation ######
####################################

# Now randomly displace in x and y up %20 of their spacing (sf)
variable           seed equal 67414
variable           dr equal 0.05*${del}
displace_atoms     fluid random ${dr} ${dr} 0 ${seed} units box


##### Setting Physical Params ######
####################################
variable           rho0 equal 1.0        #equil density  P = cs^2(rho-rho0)
variable           mp equal ${rho0}/${n} #particle mass
variable           cs equal 2        #speed of sound - pressure EOS
variable           eta equal 2#0.1# 0.1          #dynamic viscosity
variable           zeta equal 1          #artificial viscosity - stabilizing term
variable           Dr equal 0.2*${h3}*${cs} #density diffusion - stabilizing term
#variable           D equal 1.0             
#variable	       kappa equal ${D}*${rho0}/${mp}
#external force
#variable           fext equal 5e-3/${n}

# set the particle properties
mass               * ${mp}
set                group all rho ${rho0}
set                group all phase 0
set                group all temp 1.0

variable           ux atom  0.01*x #sin(2*PI*x/lx)*cos()
variable           uy atom  -0.01*y 
velocity           all set v_ux v_uy 0.0 units box


##### Setting Dynamic Equations ####
####################################
fix                1 all rheo ${h3} CRK1 35 shift # RK1 125 shift
fix                2 all rheo/viscosity constant ${eta} 
fix                3 all rheo/surface ${h3} 1.4 1

fix 8 all balance 200 0.9 shift xy 20 1.1


pair_style         rheo ${h3} artificial/visc ${zeta} rho/damp ${Dr}# tension -0.001  #pressure taitwater rho/damp ${Dr} 
pair_coeff         * * ${rho0} ${cs}

# Define the Timestep
variable           dt_max equal  0.125*${h3}/${cs}/3
#variable           dt_max equal  0.1*${h3}*${h3}/${eta}/9
variable           dx_max equal ${h3}/100
#fix                4 all dt/reset 1 NULL ${dt_max} ${dx_max} units box #keyword values ...
timestep           ${dt_max} 


##### Defining Output Settings  ####
####################################

#Comput atom propreties to output in dump file
compute            den all property/atom rho
compute            phase all property/atom phase
compute            eta all property/atom viscosity
compute            surf all property/atom surface
compute            rtemp all property/atom temp

# log file output and output frequency
thermo             400
thermo_style       custom step time etotal temp press
thermo_modify      norm no

# define a dump file
dump               1 all custom 400 dump.test id type x y vx vy fx fy c_den c_phase f_rheo_chi_chi c_eta c_surf c_rtemp

# modify neighbor bin size based on kernel cutoff
variable           skin equal 0.2*${h3}
neighbor           ${skin} bin
neigh_modify       one 10000   #increase # of allowed neighbors

#run for N steps
run 250000
