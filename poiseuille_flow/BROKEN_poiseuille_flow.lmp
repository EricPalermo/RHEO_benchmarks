dimension          2
units              lj
boundary           p p p
atom_style         rheo
comm_modify        vel yes
newton off

##### Particle Generation #######
##################################

#System dimensions
variable           width equal 10 #Channel width (y direction)
variable           length equal 2*${width} #Channel width (x direction)

## Particle Lattice/Resolution Parameters
variable           sf equal 0.25 #25 #/${L} #scaling of unit cell #scale factor for particle resolution
variable           nb equal 1    #number of basis atoms depends on lattice
variable           n equal ${nb}/(${sf}^2) # number of particles per volume
variable           del equal ${sf}#*sqrt(2) # distance between particles
variable           dz equal 0.1*${sf} #For 2D, make sure that z-dimension only has 1 particle layer
lattice            sq ${n} #create a set of potential particle locations

# SPH Smoothing Kernel Length
variable           hd equal 3.5
variable           h3 equal ${hd}*${del}

#create simulation box
region             box block 0 ${length} -${width} ${width} -${dz} ${dz} units box #Create a simulation region
create_box         2 box #create a simulation box from the region box - with 2 types of atoms

#define regions
region             upper block INF INF 9 10 -${dz} ${dz} units box#create the region of top plate
region             lower block INF INF -10 -9 -${dz} ${dz} units box
region             boundary union 2 upper lower
region             flow block INF INF -8.99 8.99 -${dz} ${dz} units box

#create atoms in regions
create_atoms       2 region boundary
create_atoms       1 region flow

# define atom groups
group              fluid type 1
group              rigid type 2

#Randomly displace in x and y up %20 of their spacing (sf)
variable           seed equal 135414
variable           dr equal 0.1*${del}
displace_atoms     fluid random ${dr} ${dr} 0 ${seed} units box

##### Setting Physical Parameters #######
################################## 

# Potential parameters eta = 1, cs = 0 so force gives laplacian
variable           rho0 equal 1.0 #Equilibrium density P=cs^2(rho-rho0)
variable           mp equal ${rho0}/${n} #particle mass, fixed by density and number density
variable           cs equal 5.0 #speed of sound - for pressure EoS
variable           eta equal 1 #dynamic viscosity
variable           zeta equal 1 #artificial viscosity - stabilizing term
variable           Dr equal 0.05*${h3}*${cs} #density diffusion - stabilizing term to diffuse noise throughout the system
#variable          D equal 1.0 
#variable          kappa equal ${D}*${rho0}/${mp}

##### Setting Particle Properties #######
##################################

# Assign the same mass to all particles
mass               * ${mp}

# Assign particle groups to a phase (4=solid, 0=fluid)
set                group rigid phase 4
set                group fluid phase 0

#Initial temperature
set                group all temp 1.0

#Initial velocities
compute	            mobile fluid temp #Compute temperature for atoms in the flow group; label value as mobile
velocity            fluid create 1.0 482748 temp mobile #Create ensemble of velocites (seed 482748) given T=1

#Initial density
set                group all rho ${rho0}


##### Define Physical Equations #######
################################## 

fix                1 all rheo ${h3} CRK2 0 shift # rhosum 1  shift
fix                2 all rheo/surface ${h3} 1.5 10                 
#fix                3 all rheo/viscosity constant ${eta}
fix                3 all rheo/viscosity power ${eta} 1e-3 1e-2 0.5

pair_style         rheo ${h3} artificial/visc ${zeta} rho/damp ${Dr}  #pressure taitwater rho/damp ${Dr} 
pair_coeff         * * ${rho0} ${cs}

#This rescales temp to prevent the system from expanding indefinitely
# fix	         4 fluid temp/rescale 500 1.0 1.0 0.05 1.0
# fix_modify   4 temp mobile


##### Define Poiseuille Flow System Boundaries #######
################################## 

variable           fext equal 1e-2/${n} #External force (acts as a pressure gradient)
fix                5 rigid setforce 0.0 0.0 0.0
fix                6 fluid addforce ${fext} 0.0 0.0
#fix	               7 all enforce2d

##### Timesteps #######
################################## 

#Ensures that the timestep is smaller than values, as per CFL criteria
variable           dt_max equal  0.1*${h3}/${cs}/3 

#variable           dx_max equal ${h3}/100
timestep           ${dt_max} 
variable           t_tot equal 100
variable           Nsteps equal round(${t_tot}/${dt_max})

##### Defining Output Setting #######
################################## 

#Compute atom properties to output in dump file
compute            den all property/atom rho
compute            phase all property/atom phase
compute            eta all property/atom viscosity

# #Define a chunk consisting of the fluid atoms
# compute            fluid_chunk fluid chunk/atom type
# #For the fluid_chunk, calculate the average x velocity
# fix                8 fluid ave/chunk 10 10 100 fluid_chunk vx norm none file vel.profile

#log file output and output frequency
thermo             500
thermo_style       custom step time ke temp press
thermo_modify      norm no #report properties as extensive, not intensive (i.e. per mol)

#define a dump file
dump               1 all custom 500 poise.atoms id type x y vx vy fx fy c_den c_phase f_rheo_chi_chi c_eta
dump               2 all netcdf 500 poise.nc id type x y vx vy fx fy c_den c_phase f_rheo_chi_chi c_eta

#modify neighbor bin size based on the cutoff distance h3
variable           skin equal 0.2*${h3}
neighbor           ${skin} bin
neigh_modify       one 10000 #increase number of allowed neighbors

#run for n steps
run ${Nsteps}